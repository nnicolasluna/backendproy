<div class="detail-container">
    <div class="header">
        <button class="btn-back" routerLink="/evaluaciones">
            <i class="fas fa-arrow-left"></i> Volver
        </button>
        <h2>Detalle de Evaluación</h2>
    </div>

    <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <p>Cargando detalles...</p>
    </div>

    <div *ngIf="error" class="error-state">
        <p>{{ error }}</p>
        <button routerLink="/evaluaciones">Volver a la lista</button>
    </div>

    <div *ngIf="evaluation" class="content">
        <!-- Info General -->
        <div class="info-card">
            <div class="info-header">
                <h3>Información del Dispositivo</h3>
                <span class="date">{{ evaluation.fecha_creacion | date:'medium' }}</span>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="label">Marca</span>
                    <span class="value">{{ evaluation.dispositivo.marca }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Modelo</span>
                    <span class="value">{{ evaluation.dispositivo.modelo }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Android</span>
                    <span class="value">{{ evaluation.dispositivo.version_android }}</span>
                </div>
                <div class="info-item">
                    <span class="label">Serial</span>
                    <span class="value">{{ evaluation.dispositivo.serial }}</span>
                </div>
            </div>
        </div>

        <!-- Lista de Archivos -->
        <div class="files-section">
            <h3>Archivos Extraídos ({{ evaluation.archivos?.length || 0 }})</h3>

            <div class="files-list">
                <div *ngFor="let file of evaluation.archivos" class="file-item clickable" (click)="openPreview(file)">
                    <div class="file-icon" [ngClass]="getFileType(file)">
                        <i class="fas" [ngClass]="getFileIcon(file)"></i>
                    </div>
                    <div class="file-details">
                        <div class="file-name">{{ file.nombre }}</div>
                        <div class="file-meta">
                            <span class="size">{{ formatBytes(file.tamano) }}</span>
                            <span class="type">{{ file.tipo }}</span>
                            <span class="path">{{ file.ruta }}</span>
                        </div>

                        <!-- Metadata Específica -->
                        <div *ngIf="file.metadata && (file.metadata | json) !== '{}'" class="extra-metadata">
                            <div *ngFor="let item of file.metadata | keyvalue" class="meta-tag">
                                <strong>{{ item.key }}:</strong> {{ item.value }}
                            </div>
                        </div>
                    </div>
                    <div class="preview-indicator">
                        <i class="fas fa-eye"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div *ngIf="isModalOpen && selectedFile" class="preview-modal" (click)="onModalBackdropClick($event)">
    <div class="modal-content">
        <button class="modal-close" (click)="closePreview()">
            <i class="fas fa-times"></i>
        </button>

        <div class="modal-header">
            <h3>{{ selectedFile.nombre }}</h3>
            <span class="modal-file-info">{{ formatBytes(selectedFile.tamano) }} • {{ selectedFile.tipo }}</span>
        </div>

        <div class="modal-body">
            <!-- Image Preview -->
            <div *ngIf="getFileType(selectedFile) === 'image'" class="preview-image">
                <img [src]="getFileUrl(selectedFile.id)" [alt]="selectedFile.nombre" />
            </div>

            <!-- Audio Preview -->
            <div *ngIf="getFileType(selectedFile) === 'audio'" class="preview-audio">
                <div class="audio-icon">
                    <i class="fas fa-music"></i>
                </div>
                <audio controls [src]="getFileUrl(selectedFile.id)">
                    Tu navegador no soporta el elemento de audio.
                </audio>
            </div>

            <!-- Video Preview -->
            <div *ngIf="getFileType(selectedFile) === 'video'" class="preview-video">
                <video controls [src]="getFileUrl(selectedFile.id)">
                    Tu navegador no soporta el elemento de video.
                </video>
            </div>

            <!-- PDF/Document Preview -->
            <div *ngIf="getFileType(selectedFile) === 'document'" class="preview-document">
                <iframe [src]="getFileUrl(selectedFile.id)" type="application/pdf"></iframe>
            </div>

            <!-- Other Files -->
            <div *ngIf="getFileType(selectedFile) === 'other'" class="preview-other">
                <div class="other-icon">
                    <i class="fas fa-file"></i>
                </div>
                <p>Este tipo de archivo no se puede previsualizar</p>
                <a [href]="getFileUrl(selectedFile.id)" download class="btn-download">
                    <i class="fas fa-download"></i> Descargar Archivo
                </a>
            </div>
        </div>
    </div>
</div>